name: Deploy Laravel via SSH

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest

    steps:
      - name: ‚úÖ Verificar secrets obrigat√≥rias
        run: |
          MISSING=0

          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "::error::‚ùå SSH_PRIVATE_KEY est√° vazia ou n√£o foi definida."
            MISSING=1
          fi

          if [ -z "${{ secrets.SSH_USER }}" ]; then
            echo "::error::‚ùå SSH_USER est√° vazia ou n√£o foi definida."
            MISSING=1
          fi

          if [ -z "${{ secrets.SSH_DIRECT_IP }}" ]; then
            echo "::error::‚ùå SSH_DIRECT_IP est√° vazia ou n√£o foi definida."
            MISSING=1
          fi

          if [ -z "${{ secrets.SERVER_DIR }}" ]; then
            echo "::error::‚ùå SERVER_DIR est√° vazia ou n√£o foi definida."
            MISSING=1
          fi

          if [ "$MISSING" -ne 0 ]; then
            echo "::error::‚ùå Existem secrets ausentes. Corrija antes de continuar o deploy."
            exit 1
          fi

      - name: Checkout c√≥digo
        uses: actions/checkout@v3

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: üöÄ Deploy via SSH
        run: |
          SSH_USER="${{ secrets.SSH_USER }}"
          SSH_IP="${{ secrets.SSH_DIRECT_IP }}"
          SERVER_DIR="${{ secrets.SERVER_DIR }}"

          ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_IP bash -s <<EOF
          cd $SERVER_DIR
          echo "üì¶ Atualizando c√≥digo..."
          git pull origin main

          echo "üì¶ Instalando depend√™ncias PHP..."
          composer install --no-interaction --prefer-dist --optimize-autoloader

          echo "üß© Executando migrations..."
          php artisan migrate --force

          echo "‚öôÔ∏è Cacheando configura√ß√µes..."
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache

          echo "üîê Ajustando permiss√µes..."
          chown -R www-data:www-data .
          chmod -R 775 storage bootstrap/cache

          echo "‚úÖ Deploy finalizado com sucesso!"
EOF

